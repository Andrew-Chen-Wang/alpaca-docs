<script>
  (function () {
    "use strict";

    var section = document.querySelectorAll(".book-page h2");
    var sections = {};
    var i = 0;

    Array.prototype.forEach.call(section, function (e) {
      sections[e.id] = e.offsetTop;
    });

    window.onscroll = function () {
      var scrollPosition =
        document.documentElement.scrollTop || document.body.scrollTop;

      for (i in sections) {
        if (sections[i] <= scrollPosition) {
          var q = document.querySelector(".active");

          if (!q.classList.contains("desktop-top-link")) {
            q.setAttribute(
              "class",
              q.getAttribute("class").replace(/\bactive\b/, "")
            );
            q = document.querySelector("a[href*=" + i + "]");
            q.setAttribute("class", q.getAttribute("class") + " active");
          }
        }
      }
    };
  })();

  {
    {
      "/* Add headers to scrollspy */" | safeJS;
    }
  }
  var headers = document.querySelectorAll(".book-page h2");
  var scrollspy = document.getElementById("scrollspy");

  if (scrollspy) {
    if (headers.length > 0) {
      for (var i = 0; i < headers.length; i++) {
        var li = document.createElement("li");
        li.setAttribute("class", "anchor");

        var a = document.createElement("a");
        a.setAttribute("href", "#" + headers[i].id);
        var node = headers[i].cloneNode();
        var title = headers[i].innerText.replace("#", ""); // node.removeChild(node.lastChild)
        a.setAttribute("title", title);
        a.innerHTML = title;

        li.appendChild(a);
        scrollspy.appendChild(li);
      }
    } else {
      scrollspy.parentElement.removeChild(scrollspy);
    }

    {
      {
        "/* Add permanent link next to the headers */" | safeJS;
      }
    }
    var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

    for (var i = 0; i < headers.length; i++) {
      var a = document.createElement("a");
      a.setAttribute("class", "headerlink");
      a.setAttribute("href", "#" + headers[i].id);
      a.setAttribute("title", "Permanent link");
      // a.innerHTML = {{ or .Site.Params.permalink "Â¶" }};
      // headers[i].appendChild(a);
    }
  }
</script>

<script>
  /* Used to resize fixed position desktop top nav */
  function handleDesktopNavResize() {
    try {
      const desktopTopNav = document.querySelector("nav.desktop-top-nav");
      const pageContent = document.querySelector(".book-page");
      const pageWidth = pageContent.getBoundingClientRect().width;
      desktopTopNav.style.width = pageWidth + "px";
    } catch (err) {
      console.error("Failed to resize desktop top nav -> ", err);
    }
  }

  /* Highlights the desktop top nav product on api reference pages that are related to it  */
  function highlightDesktopTopNavOnAPIReferences() {
    const desktopTopNav = document.querySelector("nav.desktop-top-nav");
    const urlArray = window.location.href.split("/");
    const indexOfAPIReferences = urlArray.indexOf("api-references");

    if (
      indexOfAPIReferences !== -1 &&
      typeof urlArray[indexOfAPIReferences + 1] !== "undefined"
    ) {
      const apiReferenceSection = urlArray[indexOfAPIReferences + 1]
        .replaceAll("-", " ")
        .replace("api", "")
        .trim();

      for (let i = 0; i < desktopTopNav.children.length; i++) {
        if (
          desktopTopNav.children[i].textContent.toLowerCase().replace("api", "").trim() ===
          apiReferenceSection
        ) {
          console.log("Match!");
          desktopTopNav.children[i].classList.add("active");
        } else {
          console.log(
            "no match",
            desktopTopNav.children[i].textContent.toLowerCase().replace("api", "").trim(),
            apiReferenceSection
          );
          desktopTopNav.children[i].classList.remove("active");
        }
      }
    }
  }

  window.addEventListener("DOMContentLoaded", function () {
    window.addEventListener("resize", handleDesktopNavResize);
    handleDesktopNavResize();
    highlightDesktopTopNavOnAPIReferences();
  });
</script>
